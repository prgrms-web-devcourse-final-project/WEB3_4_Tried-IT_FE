name: "CloudFront S3 Deployment"
description: "S3ì— ë°°í¬í•˜ê³  CloudFront ë¬´íš¨í™”ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤"
inputs:
  app:
    description: "ë°°í¬í•  ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„"
    required: true
  output-dir:
    description: "ë°°í¬í•  íŒŒì¼ë“¤ì´ ìˆëŠ” ë””ë ‰í† ë¦¬ ê²½ë¡œ"
    required: true
  github-token:
    description: "GitHub í† í°"
    required: true
  aws-access-key-id:
    description: "AWS Access Key ID"
    required: true
  aws-secret-access-key:
    description: "AWS Secret Access Key"
    required: true
  aws-default-region:
    description: "AWS ê¸°ë³¸ ë¦¬ì „"
    required: true
  aws-s3-bucket-name:
    description: "AWS S3 ë²„í‚· ì´ë¦„"
    required: true
  aws-cf-distribution-id:
    description: "AWS CloudFront ë°°í¬ ID"
    required: true

runs:
  using: "composite"
  steps:
    - name: AWS ìê²© ì¦ëª… ì„¤ì •
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-secret-access-key: ${{ inputs.aws-secret-access-key }}
        aws-region: ${{ inputs.aws-default-region }}

    - name: Pnpm ì„¤ì •
      uses: pnpm/action-setup@v4

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v3
      with:
        node-version: "20"
        cache: "pnpm"

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      shell: bash
      run: pnpm install --frozen-lockfile

    - name: ë¹Œë“œ
      shell: bash
      run: pnpm --filter ${{ inputs.app }} build

    - name: S3ì— íŒŒì¼ ì—…ë¡œë“œ
      shell: bash
      run: |
        echo "ğŸš€ S3 ë²„í‚·ì— íŒŒì¼ ì—…ë¡œë“œ ì¤‘: ${{ inputs.aws-s3-bucket-name }}"
        aws s3 sync ${{ inputs.output-dir }} s3://${{ inputs.aws-s3-bucket-name }} --delete

    - name: CloudFront ë¬´íš¨í™”
      shell: bash
      run: |
        echo "ğŸ”„ CloudFront ë°°í¬ ë¬´íš¨í™” ì¤‘: ${{ inputs.aws-cf-distribution-id }}"
        aws cloudfront create-invalidation --distribution-id ${{ inputs.aws-cf-distribution-id }} --paths "/*"

    - name: ë°°í¬ ì™„ë£Œ ë©”ì‹œì§€
      shell: bash
      run: |
        echo "âœ… ${{ inputs.app }} ì•±ì´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "S3 ë²„í‚·: ${{ inputs.aws-s3-bucket-name }}"
        echo "CloudFront ë°°í¬ ID: ${{ inputs.aws-cf-distribution-id }}"
